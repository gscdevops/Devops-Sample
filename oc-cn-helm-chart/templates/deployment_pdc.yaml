apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ .Values.ocpdc.labels.name }}-deployment
    namespace: {{ .Release.Namespace }}
    labels:
        app.kubernetes.io/name: {{ .Values.ocpdc.labels.name }}
        app.kubernetes.io/version: {{ .Values.ocpdc.labels.version }}
        app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
    minReadySeconds: 0
    paused: false
    progressDeadlineSeconds: {{ .Values.ocpdc.deployment.deadlineSeconds }}
    replicas: 1
    revisionHistoryLimit: {{ .Values.ocpdc.deployment.revisionHistLimit }}
    selector: 
        matchLabels:
            app.kubernetes.io/name: {{ .Values.ocpdc.labels.name }}
    strategy: 
        type: Recreate
    template:
        metadata:
            labels: 
                app.kubernetes.io/name: {{ .Values.ocpdc.labels.name }}
                app.kubernetes.io/version: {{ .Values.ocpdc.labels.version }}
                app.kubernetes.io/managed-by: {{ .Release.Service }}
        spec:
            containers:
            -   name: {{ .Values.ocpdc.labels.name }}-cont
                image: {{ .Values.imageRepository }}{{ .Values.ocpdc.deployment.imageName }}{{ .Values.ocpdc.deployment.imageTag }}
                imagePullPolicy: {{ .Values.ocpdc.deployment.imagePullPolicy }}
                ports:
                -   name: port-http
                    containerPort: {{ .Values.ocpdc.configEnv.httpPort }}
                -   name: port-https
                    containerPort: {{ .Values.ocpdc.configEnv.httpsPort }}
                envFrom:
                -   configMapRef:
                        name: {{ .Values.ocpdc.configEnv.name }}
                -   secretRef:
                        name: {{ .Values.ocpdc.secretEnv.name }}
                -   secretRef:
                        name: {{ .Values.ocpdc.secretEnv.name }}
                env:
                - name: ENABLE_SSL
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: ENABLE_SSL
                - name: SERVICE_FQDN
                  value: "{{ .Values.ocbrm.brm_apps.deployment.host }}"
                - name: LIBRARYEXTENSION
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: LIBRARYEXTENSION
                - name: LOG_LEVEL
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: LOG_LEVEL
                - name: CLIENT_WALLET_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: client_wallet_password
                - name: OMS_SCHEMA_USERNAME
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: OMS_SCHEMA_USERNAME
                - name: OMS_SCHEMA_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: oms_schema_password
                - name: OMS_DB_ALIAS
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: OMS_DB_ALIAS
                - name: BRM_ROOT_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: brm_root_password
                - name: ROOT_WALLET_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: root_wallet_password
                - name: SERVER_WALLET_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: server_wallet_password
                - name: CM_SERVICE_HOST
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: CM_SERVICE_HOST
                - name: CM_SERVICE_PORT
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: CM_SERVICE_PORT
                - name: VIRTUAL_TIME_ENABLED
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: VIRTUAL_TIME_ENABLED
                - name: VIRTUAL_TIME_SETTING
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: VIRTUAL_TIME_SETTING
                - name: SHARED_VIRTUAL_TIME_FILE
                  value: {{ .Values.ocbrm.virtual_time.pvt }}/pin_virtual_time_file
                - name: IFW_INTEGRATE_USERNAME
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: INTEGRATE_USERNAME
                - name: IFW_INTEGRATE_SID
                  valueFrom:
                    configMapKeyRef:
                      name: oms-common-config
                      key: INTEGRATE_SID
                - name: IFW_INTEGRATE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: pipeline_schema_password
                - name: INIT_DB
                  value: "{{ .Values.ocbrm.init_database}}"
                - name: OLD_CLIENT
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: old_client
                - name: OLD_ROOT
                  valueFrom:
                    secretKeyRef:
                      name: oms-schema-password
                      key: old_root
                                                                           
                volumeMounts:
                -   name: {{ .Values.ocpdc.deployment.volMntKeyStore.name }}
                    mountPath: {{ .Values.ocpdc.deployment.volMntKeyStore.mountPath }}
                -   name: {{ .Values.ocpdc.deployment.volMntPolicy.name }}
                    mountPath: {{ .Values.ocpdc.deployment.volMntPolicy.mountPath }}
                -   name: {{ .Values.ocpdc.deployment.volMntLogs.name }}
                    mountPath: {{ .Values.ocpdc.deployment.volMntLogs.mountPath }}
                -   name: virtual-time-volume
                    mountPath: {{ .Values.ocbrm.virtual_time.pvt }}
                -   name: pin-conf-config-brm-apps-volume-2
                    mountPath: /oms/pin_confs2
                -   name: infranet-properties-brm-apps-volume
                    mountPath: /oms/infranets
                -   name: loadifw-reg-volume
                    mountPath: /oms/ifw/tools/XmlLoader/LoadIfwConfig.reg.tmpl
                    subPath: LoadIfwConfig.reg.tmpl
                -   name: common-semaphore
                    mountPath: /oms/ifw/semaphore/

            volumes:
            -   name: {{ .Values.ocpdc.deployment.volMntKeyStore.name }}
                secret:
                    secretName: {{ .Values.ocpdc.secretKeyStore.name }}
            -   name: {{ .Values.ocpdc.deployment.volMntPolicy.name }}
                persistentVolumeClaim:
                    claimName: {{ .Values.ocpdc.persistentVolClaim.name }}
            -   name: {{ .Values.ocpdc.deployment.volMntLogs.name }}
                emptyDir: {}
            -   name: virtual-time-volume
                persistentVolumeClaim:
                    claimName: {{ .Values.ocbrm.virtual_time.pvc }}
            -   name: loadifw-reg-volume
                configMap:
                  name: loadifwreg-config
            -   name: common-semaphore
                persistentVolumeClaim:
                    claimName: common-semaphore

            - name: pin-conf-config-brm-apps-volume-2
              configMap:
                name: pin-conf-config-brm-apps-2
                items:
                  - key: load_config.conf
                    path: load_config.conf
                  - key: setup_scripts.conf
                    path: setup_scripts.conf
            - name: infranet-properties-brm-apps-volume
              configMap:
                name: infranet-properties-brm-apps
                items:
                  - key: load_price_list_Infranet.properties
                    path: load_price_list_Infranet.properties
            

